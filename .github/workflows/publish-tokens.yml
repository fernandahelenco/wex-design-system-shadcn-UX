name: Publish Design Tokens

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.filter.outputs.changed }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check for changes in design-tokens
        id: filter
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against base branch
            BASE_SHA=${{ github.event.pull_request.base.sha }}
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
            if git diff --name-only $BASE_SHA $HEAD_SHA | grep -q "^packages/design-tokens/"; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          else
            # For pushes, compare against previous commit
            if git diff --name-only HEAD~1 HEAD | grep -q "^packages/design-tokens/"; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

  publish-tokens:
    needs: check-changes
    if: needs.check-changes.outputs.changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Use Node.js Version 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm ci

      - name: Generate Runtime Configuration File
        run: |
          rm -rf .npmrc
          echo "registry=https://registry.npmjs.org/" > .npmrc
          echo "@wex:registry=https://artifactory.wexinc.com/artifactory/api/npm/npm-local/" >> .npmrc
          echo "//artifactory.wexinc.com/artifactory/api/npm/npm-local/:_authToken=${{ secrets.ARTIFACTORY_TOKEN }}" >> .npmrc
          echo "//artifactory.wexinc.com/artifactory/api/npm/npm-local/:always-auth=true" >> .npmrc

      - name: Build Design Tokens
        run: node scripts/build-tokens.cjs

      - name: Get Package Version
        id: package
        run: echo "version=$(node -p "require('./packages/design-tokens/package.json').version")" >> $GITHUB_OUTPUT

      - name: Publish to Artifactory
        working-directory: packages/design-tokens
        run: |
          jf npm publish --build-name=${{ github.event.repository.name }} --build-number=${{ github.run_number }}
          jf rt bp "${{ github.event.repository.name }}" "${{ github.run_number }}"

      - name: Promote the Release to Production
        run: |
          jf rt bpr \
            --status=promoted \
            --comment="Promoting build ${{ github.run_number }} to production" \
            "${{ github.event.repository.name }}" \
            "${{ github.run_number }}" \
            "wex-npm-prod"

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "v${{ steps.package.outputs.version }}"
          release_name: Design Tokens Version ${{ steps.package.outputs.version }}
          draft: false
          prerelease: false
